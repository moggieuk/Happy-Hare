########################################################################################################################
# Happy Hare MMU Software
#
# CONFIG AUTOMATICALLY CREATED FOR:
#    '[[UNIT_NAME]]':
#    '[[PARAM_VENDOR]] v[[PARAM_VERSION]]' with [[PARAM_NUM_GATES]] gates, running on a '[[PARAM_BOARD_TYPE]]' mcu with '[[PARAM_SELECTOR_TYPE]]' kinematics
#
# EDIT THIS FILE BASED ON YOUR SETUP OR PREFERABLY RUN THIS AND USE MENUCONFIG:
#    ~/Happy-Hare/install.sh -i
#
# Copyright (C) 2022-2025  moggieuk#6538 (discord)
#                          moggieuk@hotmail.com
#
# This file may be distributed under the terms of the GNU GPLv3 license.
#
# Goal: Main per-mmu unit configuration parameters for the klipper module
#
# (\_/)
# ( *,*)
# (")_(") Happy Hare Ready
#
# Notes:
#   This is a per-unit configuration. Anything shared in is `mmu.cfg`
#   The shared macro configuration is specified separately in 'mmu_macro_vars.cfg'.
#   Full details in the Happy Hare wiki: https://github.com/moggieuk/Happy-Hare/wiki
#
[mmu_parameters [[UNIT_NAME]]]

[% if PARAM_SELECTOR_TYPE not in ["VirtualSelector"] %]
# Selector control ---------------------------------------------------------------------------------------------------
# ███████╗███████╗██╗     ███████╗ ██████╗████████╗ ██████╗ ██████╗
# ██╔════╝██╔════╝██║     ██╔════╝██╔════╝╚══██╔══╝██╔═══██╗██╔══██╗
# ███████╗█████╗  ██║     █████╗  ██║        ██║   ██║   ██║██████╔╝
# ╚════██║██╔══╝  ██║     ██╔══╝  ██║        ██║   ██║   ██║██╔══██╗
# ███████║███████╗███████╗███████╗╚██████╗   ██║   ╚██████╔╝██║  ██║
# ╚══════╝╚══════╝╚══════╝╚══════╝ ╚═════╝   ╚═╝    ╚═════╝ ╚═╝  ╚═╝
#
# MMU SELECTOR: These settings control gate selection on type-A and type-C MMU's
#
[% if PARAM_SELECTOR_TYPE in ["LinearSelector", "LinearServoSelector", "LinearMultiGearSelector", "RotarySelector", "IndexedSelector", "Testing"] %]
# Selector stepper movement speeds
#
selector_move_speed: [[PARAM_SELECTOR_MOVE_SPEED]]		# mm/s speed of selector movement
[% if PARAM_SELECTOR_TYPE not in ["IndexedSelector"] %]
selector_homing_speed: [[PARAM_SELECTOR_HOMING_SPEED]]		# mm/s speed of initial selector homing move (not touch)
[% endif %]
[% if PARAM_SELECTOR_TYPE not in ["RotarySelector", "IndexedSelector"] %]
selector_touch_speed: [[PARAM_SELECTOR_TOUCH_SPEED]]		# mm/s speed of all "touch" selector moves (if stallguard configured)
[% endif %]
selector_accel: 1200			# Selector stepper acceleration
[% if PARAM_SELECTOR_TYPE not in ["RotarySelector", "IndexedSelector"] %]

# Selector touch (stallguard) operation. If stallguard is configured, then this can be used to switch on touch movement which
# can detect blocked filament path and try to recover automatically but it is more difficult to set up
#
selector_touch_enabled: [[PARAM_SELECTOR_TOUCH_ENABLED]]		# If selector touch operation configured this can be used to disable it 1=enabled, 0=disabled
[% endif %]

[% endif %]
[% if PARAM_SELECTOR_TYPE in ["RotarySelector", "Testing"] %]
# RotarySelector: The direction of filament movement can be changed per-gate to support designs like 3DChameleon
# Also if 'filament_always_gripped: 0' then an alternative gate can be selected to ungrip in the current gate
#
selector_gate_directions: [[PARAM_SELECTOR_GATE_DIRECTIONS]]	# Directions of gear depending on gate (RotarySelector).    E.g. 1, 1, 0, 0
selector_release_gates: [[PARAM_SELECTOR_RELEASE_GATES]]	# Gate to move to when releasing filament (RotarySelector). E.g. 2, 3, 0, 1

[% endif %]
[% if PARAM_SELECTOR_TYPE in ["IndexedSelector", "Testing"] %]
# IndexedSelector: This allows for centering on the gate index and repsents the movement distance from one
# side of the sensor to the other
#
selector_index_distance: 5		# Width (degrees if rotary) of index sensor

[% endif %]
[% if PARAM_SELECTOR_TYPE in ["MacroSelector"] %]
# MacroSelector:
#
select_tool_macro: select_tool_macro	# Name of macro called to change gates
select_tool_num_switches: 0		# Number of switches

[% endif %]
[% if PARAM_SELECTOR_TYPE in ["LinearServoSelector", "Testing"] %]
# LinearServoSelector: Angle of the servo in three named positions
#   up   = tool is selected and filament is allowed to freely move through gate
#   down = to grip filament
#   move = ready the servo for selector move (optional - defaults to up)
# Note these positions are only for initial config and are replaced with calibrated servo positions in `mmu_vars.cfg`
#
servo_up_angle:   [[PARAM_SERVO_UP_ANGLE]]			# ERCF: MG90S: 30  ; SAVOX SH0255MG: 140 ; Tradrack: 145
servo_down_angle: [[PARAM_SERVO_DOWN_ANGLE]]			# ERCF: MG90S: 140 ; SAVOX SH0255MG: 30  ; Tradrack: 1
servo_move_angle: [[PARAM_SERVO_MOVE_ANGLE]]			# Optional angle used when selector is moved (defaults to up position)

servo_buzz_gear_on_down: [[PARAM_SERVO_BUZZ_GEAR_ON_DOWN]]		# Whether to "buzz" the gear stepper on down to aid engagement

[% endif %]
[% if PARAM_SELECTOR_TYPE in ["ServoSelector", "Testing"] %]
# ServoSelector: Selector servo positions are stored in `mmu_vars.cfg` after calibration but initial gate angles
# can be specified as a list. If empty, calibration will be forced. Note that the "release angle" is by default the
# nearest position between calibrated selection angles. This can be overriden by setting and explicit servo_release_angle.
#
servo_gate_angles: [[PARAM_SERVO_GATE_ANGLES]]	# Optional default list of gate angles (overriden by calibration)
servo_bypass_angle: -1			# Optional default servo angle when bypass is selected, -1=No bypass angle
servo_release_angle: -1			# Optionally force a specific "release" angle, -1=Default (between gate angles) behavior

[% endif %]
[% if PARAM_SELECTOR_TYPE in ["LinearServoSelector", "ServoSelector", "Testing"] %]
# Fine tuning servo movement. Usually defaults are fine but tweak for slow servos
#
servo_duration: [[PARAM_SERVO_DURATION]]			# Duration of PWM burst sent to servo (default non-active mode, automatically turns off)
servo_dwell: [[PARAM_SERVO_DWELL]]			# Minimum time given to servo to complete movement prior to next move

# Note that leaving the servo active can stress the servo and electronics (especially 5v power supply). Make sure your hardware is suitable for the job!
#
servo_always_active: [[PARAM_SERVO_ALWAYS_ACTIVE]] 		# CAUTION - CAN DAMAGE COMMON SERVOS, PLEASE USE AT YOUR OWN RISK: 1=Force servo to always stay active, 0=Release after movement
[% endif %]
[% if PARAM_SELECTOR_TYPE in ["LinearServoSelector", "Testing"] %]
servo_active_down: [[PARAM_SERVO_ACTIVE_DOWN]]		# CAUTION - CAN DAMAGE COMMON SERVOS, PLEASE USE AT YOUR OWN RISK: 1=Force servo to stay active when down only, 0=Release after movement
[% endif %]


[% endif %]
# Filament movement speeds -------------------------------------------------------------------------------------------
#  ██████╗ ███████╗ █████╗ ██████╗     ███████╗██████╗ ███████╗███████╗██████╗ ███████╗
# ██╔════╝ ██╔════╝██╔══██╗██╔══██╗    ██╔════╝██╔══██╗██╔════╝██╔════╝██╔══██╗██╔════╝
# ██║  ███╗█████╗  ███████║██████╔╝    ███████╗██████╔╝█████╗  █████╗  ██║  ██║███████╗
# ██║   ██║██╔══╝  ██╔══██║██╔══██╗    ╚════██║██╔═══╝ ██╔══╝  ██╔══╝  ██║  ██║╚════██║
# ╚██████╔╝███████╗██║  ██║██║  ██║    ███████║██║     ███████╗███████╗██████╔╝███████║
#  ╚═════╝ ╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝    ╚══════╝╚═╝     ╚══════╝╚══════╝╚═════╝ ╚══════╝
#
# MOVEMENT SPEEDS: Long moves are faster than the small ones and used for the bulk of the bowden movement. Note that a typically encoder
# cannot keep up much above 450mm/s so make sure 'bowden_apply_correction' is off at very high speeds!
#
gear_from_filament_buffer_speed: [[PARAM_GEAR_FROM_FILAMENT_BUFFER_SPEED]]		# mm/s Speed when loading filament from buffer. Conservative is 100mm/s, Max around 400mm/s
gear_from_filament_buffer_accel: [[PARAM_GEAR_FROM_FILAMENT_BUFFER_ACCEL]]		# Normal acceleration when loading filament

[% if MMU_HAS_FILAMANT_BUFFER %]
# You can set two fast load speeds depending on whether pulling from the spool or filament buffer (except first time load). This can be helpful
# in allowing faster loading from buffer and slower when pulling from the spool because of the additional friction (prevents loosing steps)
#
gear_from_spool_speed: [[PARAM_GEAR_FROM_SPOOL_SPEED]]		# mm/s Fast speed when loading filament (from the spool if has_filament_buffer: 1)
gear_from_spool_accel: [[PARAM_GEAR_FROM_SPOOL_ACCEL]]		# Acceleration when loading from spool

[% endif %]
# Unloading speed can be tuned if you have a rewinder system that imposes additional limits.
#
gear_unload_speed: [[PARAM_GEAR_UNLOAD_SPEED]]			# mm/s Use (lower) speed when unloading filament (defaults to "from spool" speed)
gear_unload_accel: [[PARAM_GEAR_UNLOAD_ACCEL]]			# Acceleration when unloading filament (defaults to "from spool" accel)

gear_homing_speed: [[PARAM_GEAR_HOMING_SPEED]]			# mm/s Speed of gear stepper only homing moves (e.g. homing to gate or extruder)

gear_short_move_speed: [[PARAM_GEAR_SHORT_MOVE_SPEED]]		# mm/s Speed when making short moves (including incremental retracts with encoder)
gear_short_move_accel: [[PARAM_GEAR_SHORT_MOVE_ACCEL]]		# Usually the same as gear_from_buffer_accel (for short movements)
gear_short_move_threshold: [[PARAM_GEAR_SHORT_MOVE_THRESHOLD]]		# Move distance that controls application of 'short_move' speed/accel


# Gate loading/unloading ---------------------------------------------------------------------------------------------
#  ██████╗  █████╗ ████████╗███████╗    ██╗      ██████╗  █████╗ ██████╗
# ██╔════╝ ██╔══██╗╚══██╔══╝██╔════╝    ██║     ██╔═══██╗██╔══██╗██╔══██╗
# ██║  ███╗███████║   ██║   █████╗      ██║     ██║   ██║███████║██║  ██║
# ██║   ██║██╔══██║   ██║   ██╔══╝      ██║     ██║   ██║██╔══██║██║  ██║
# ╚██████╔╝██║  ██║   ██║   ███████╗    ███████╗╚██████╔╝██║  ██║██████╔╝
#  ╚═════╝ ╚═╝  ╚═╝   ╚═╝   ╚══════╝    ╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝
#
# GATE LOADING/UNLOADING: These settings control the loading and unloading filament at the gate which is the parking position
# inside the MMU. Typically this would be switch sensor but you can also use an encoder. Even with encoder the endstop can be
# a switch and the encoder used for move verifcation (see advanced 'gate_endstop_to_encoder' option). Note that the `encoder`
# method, due to the nature of its operation will overshoot a little. This is not a problem in practice because the overshoot
# will simply be compensated for in the subsequent move. A +ve parking distance moves towards the MMU, -ve moves back through
# the endstop towards the toolhead. If the MMU has multiple bowden tubes to the extruder then it is possible to home to the
# extruder sensor and avoid long bowden moves completely (see require_bowden_move' in mmu_hardware.cfg)
#
# Possible gate_homing_endstop names:
#   encoder         - Detect filament position using movement of the encoder (if fitted)
#   mmu_shared_exit - Use common endstop on gate (type-A) or hub (type-B)
#   mmu_exit        - Use individual per-gate endstop (type-B MMU's)
#   extruder        - Use extruder entry sensor (Only for some type-B designs, see [mmu_machine] require_bowden_move setting)
#
# The 'preload_endstop' and associated parameters typically would be the same as 'gate_home_endstop' or '' which means the same,
# However it can be useful on type-B MMU's when preloading filament to the gate specific 'mmu_exit' sensor even if the gate
# endstop is something else.
#
gate_homing_endstop: [[PARAM_GATE_HOMING_ENDSTOP]]		# Name of gate endstop used for filament parking
gate_homing_max: [[PARAM_GATE_HOMING_MAX]]			# Maximum extra move distance to home (or actual move distance if encoder endstop)
gate_parking_distance: [[PARAM_GATE_PARKING_DISTANCE]]		# Parking position relative to homing endstop (must be retraction unless endstop is mmu_gear)

gate_preload_endstop: [[PARAM_GATE_PRELOAD_ENDSTOP]]			# Name of endstop used when preloading (default of not set = use gate_homing_endstop)
gate_preload_homing_max: [[PARAM_GATE_PRELOAD_HOMING_MAX]]		# Maximum homing distance to the mmu_gear endstop (if MMU is fitted with one)
gate_preload_parking_distance: -10	# Parking position relative to mmu_gear endstop (-ve value means move forward)
gate_preload_attempts: 5		# How many "grabbing" attempts are made to pick up the filament with preload feature

[% if MMU_HAS_ENCODER %]
gate_endstop_to_encoder: [[PARAM_GATE_ENDSTOP_TO_ENCODER]]		# Distance between gate endstop and encoder (IF both fitted. +ve if encoder after endstop)
[% endif %]
[% if PARAM_SELECTOR_TYPE in ["LinearServoSelector", "Testing"] %]
gate_load_retries: 2			# Number of times MMU will attempt to grab the filament on initial load (type-A designs with servo)
[% endif %]
[% if MMU_HAS_SENSOR_ENTRY %]
gate_autoload: 1			# If pre-gate sensor fitted this controls the automatic loading of the gate
[% endif %]
gate_final_eject_distance: [[PARAM_GATE_FINAL_EJECT_DISTANCE]]		# Additional distance to eject filament on MMU_EJECT to clear MMU's grip


# Bowden tube loading/unloading --------------------------------------------------------------------------------------
# ██████╗  ██████╗ ██╗    ██╗██████╗ ███████╗███╗   ██╗    ███╗   ███╗ ██████╗ ██╗   ██╗███████╗
# ██╔══██╗██╔═══██╗██║    ██║██╔══██╗██╔════╝████╗  ██║    ████╗ ████║██╔═══██╗██║   ██║██╔════╝
# ██████╔╝██║   ██║██║ █╗ ██║██║  ██║█████╗  ██╔██╗ ██║    ██╔████╔██║██║   ██║██║   ██║█████╗
# ██╔══██╗██║   ██║██║███╗██║██║  ██║██╔══╝  ██║╚██╗██║    ██║╚██╔╝██║██║   ██║╚██╗ ██╔╝██╔══╝
# ██████╔╝╚██████╔╝╚███╔███╔╝██████╔╝███████╗██║ ╚████║    ██║ ╚═╝ ██║╚██████╔╝ ╚████╔╝ ███████╗
# ╚═════╝  ╚═════╝  ╚══╝╚══╝ ╚═════╝ ╚══════╝╚═╝  ╚═══╝    ╚═╝     ╚═╝ ╚═════╝   ╚═══╝  ╚══════╝
#
# BOWDEN LOADING/UNLOADING: Settings that control filament movement in the bowden tube
#
bowden_homing_max: 2000			# Maximum attempted bowden move (for calibration). Should be larger than your actual bowden!

# These are the percentage of the calibrated bowden move which occurs at a fast speed (homing disabled). In most
# designs it is important that the bowden move doesn't overshoot it's target to allow for slower homing to the endstop.
# Note that additional "extra" homing distance is defined in the gate and extruder sections which is automatically added
# to the expected "slow" distance. Also note that before calibration all moves are slower homing moves.
#
bowden_fast_unload_portion: 95		# % of calibrated bowden length for fast (non-homing) unloading move
bowden_fast_load_portion:   95 		# % of calibrated bowden length for fast (non-homing) loading move

[% if MMU_HAS_ENCODER %]
# If you MMU is equiped with an encoder the following options are available:
#
# In addition to different bowden loading speeds for buffer and non-buffered filament it is possible to detect missed
# steps caused by "jerking" on a heavy spool. If bowden correction is enabled Happy Hare will "believe" the encoder
# reading and make correction moves to bring the filament to within the 'bowden_allowable_load_delta' of the end of
# bowden position (this does require a reliable encoder and is not recommended for very high speed loading >350mm/s)
#
bowden_apply_correction: 0		# 1 to enable, 0 disabled
bowden_allowable_load_delta: 20.0	# How close in mm the correction moves will attempt to get to target

# This saftey check uses the encoder to verify the filament is free of extruder before the fast bowden movement to
# reduce possibility of grinding filament. If enabled the trigger can be tuned by setting the "error tolerance" which
# represents the fraction of allowable mismatch between actual movement and that seen by encoder. Setting to 50% tolerance
# usually works well. Increasing will make test more tolerant. Value of 100% essentially disables error detection
#
bowden_pre_unload_test: 1		# 1 to check for bowden movement before full pull (slower), 0 don't check (faster)
bowden_pre_unload_error_tolerance: 50	# ADVANCED: tune pre_unload_test
[% endif %]


# Extruder homing ----------------------------------------------------------------------------------------------------
# ███████╗██╗  ██╗████████╗    ██╗  ██╗ ██████╗ ███╗   ███╗██╗███╗   ██╗ ██████╗
# ██╔════╝╚██╗██╔╝╚══██╔══╝    ██║  ██║██╔═══██╗████╗ ████║██║████╗  ██║██╔════╝
# █████╗   ╚███╔╝    ██║       ███████║██║   ██║██╔████╔██║██║██╔██╗ ██║██║  ███╗
# ██╔══╝   ██╔██╗    ██║       ██╔══██║██║   ██║██║╚██╔╝██║██║██║╚██╗██║██║   ██║
# ███████╗██╔╝ ██╗   ██║██╗    ██║  ██║╚██████╔╝██║ ╚═╝ ██║██║██║ ╚████║╚██████╔╝
# ╚══════╝╚═╝  ╚═╝   ╚═╝╚═╝    ╚═╝  ╚═╝ ╚═════╝ ╚═╝     ╚═╝╚═╝╚═╝  ╚═══╝ ╚═════╝
#
# EXTRUDER HOMING: Happy Hare needs a reference "homing point" close to the extruder from which to accurately complete the
# loading of the toolhead. This homing operation takes place after the fast bowden load and it is anticipated that that load
# operation will leave the filament just shy of the homing point. If using a toolhead sensor this initial extruder
# homing is unnecessary (but can be forced) because the homing will occur inside the extruder for the optimum in accuracy.
# You still should set this homing method because it is also used for the determination and calibration of bowden length.
#
# In addition to an entry sensor "extruder" it is possible for Happy Hare to "feel" for the extruder gear entry
# by colliding with it. This can be done with encoder based collision detection, the compression of the sync-feedback
# (aka buffer) sensor or using "touch" (stallguard) on the gear stepper. Note that encoder collision detection is not
# completely deterministic and you will have to find the sweetspot for your setup by adjusting the TMC current reduction.
# Note that reduced current during collision detection can also prevent unecessary filament griding.
#
# Possible extruder_homing_endtop names:
#   filament_compression - If you have a "sync-feedback" sensor with compression switch configured
#                          Fast bowden load will move to extruder_homing_buffer distance before extruder gear, then home
#   extruder             - If you have a "filament entry" endstop configured (Requires 'extruder' endstop)
#                          Fast bowden load will move to extruder_homing_buffer distance before sensor, then home
#   collision            - Detect the collision with the extruder gear by monitoring encoder movement (Requires encoder)
#                          Fast bowden load will move to the extruder gears
#   mmu_gear_touch       - Use touch detection when the gear stepper hits the extruder (Requires stallguard setup)
#                          Fast bowden load will move to extruder_homing_buffer distance before extruder gear, then home
#   none                 - Don't attempt to home. Only possibiliy if lacking all sensor options
#                          Fast bowden load will move to the extruder gears. Option is fine if using toolhead sensor
# Note: The homing_endstop will be ignored ("none") if a toolhead sensor is available unless "extruder_force_homing: 1"
#
extruder_homing_endstop: [[PARAM_EXTRUDER_HOMING_ENDSTOP]]	# Filament homing method/endstop name (fallback if toolhead sensor not available)
extruder_homing_max: 100		# Maximum distance to advance in order to attempt to home to the extruder

[% if MMU_HAS_ENCODER %]
extruder_collision_homing_current: 30	# % gear stepper current (10%-100%) to use when collision homing to extruder

[% endif %]
[% if MMU_HAS_SENSOR_TOOLHEAD %]
# If you have a toolhead sensor it will always be used as a homing point making the homing outside of the extruder
# potentially unnecessary. However you can still force this initial homing step by setting this option in which case
# the filament will home to the extruder and then home to the toolhead sensor in two steps
#
extruder_force_homing: 0


[% endif %]
# Toolhead loading and unloading -------------------------------------------------------------------------------------
# ████████╗ ██████╗  ██████╗ ██╗     ██╗  ██╗███████╗ █████╗ ██████╗     ██╗      ██████╗  █████╗ ██████╗
# ╚══██╔══╝██╔═══██╗██╔═══██╗██║     ██║  ██║██╔════╝██╔══██╗██╔══██╗    ██║     ██╔═══██╗██╔══██╗██╔══██╗
#    ██║   ██║   ██║██║   ██║██║     ███████║█████╗  ███████║██║  ██║    ██║     ██║   ██║███████║██║  ██║
#    ██║   ██║   ██║██║   ██║██║     ██╔══██║██╔══╝  ██╔══██║██║  ██║    ██║     ██║   ██║██╔══██║██║  ██║
#    ██║   ╚██████╔╝╚██████╔╝███████╗██║  ██║███████╗██║  ██║██████╔╝    ███████╗╚██████╔╝██║  ██║██████╔╝
#    ╚═╝    ╚═════╝  ╚═════╝ ╚══════╝╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚═════╝     ╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝
#
# TOOLHEAD LOADING/UNLOADING: It is possible to define highly customized loading and unloading sequences, however, unless
# you have a specialized setup it is probably easier to opt for the built-in toolhead loading and unloading sequence which
# already offers a high degree of customization. If you need even more control then edit the _MMU_LOAD_SEQUENCE and
# _MMU_UNLOAD_SEQUENCE macros in mmu_sequence.cfg - but be careful!
#
# An MMU must have a known point at the end of the bowden from which it can precisely load the extruder. Generally this
# will either be the extruder entrance (which is controlled with settings above) or by homing to toolhead sensor. If
# you have toolhead sensor it is past the extruder gear and the driver needs to know the max distance (from end of
# bowden move) to attempt homing
#
toolhead_homing_max: 40			# Maximum distance to advance in order to attempt to home to defined homing endstop

# Distance added to the extruder unload movement to ensure filament is free of extruder. This adds some degree of tolerance
# to slightly incorrect configuration or extruder slippage. However don't use as an excuse for incorrect toolhead settings
#
toolhead_unload_safety_margin: 10	# Extra movement safety margin (default: 10mm)

# If not synchronizing gear and extruder and you experience a "false" encoder clog detection immediately after the tool
# change it might be because of a long bowden and/or large internal diameter that causes slack in the filament. This optional
# move will tighten the filament after a load by % of current clog detection length. Gear stepper will run at 50% current
#
toolhead_post_load_tighten: 60		# % of clog detection length, 0 to disable. Ignored if 'sync_to_extruder: 1'

# If synchronizing gear and extruder and you have a sync-feedback "buffer" (switch based or proportional) this setting
# determines whether to use it to create neutral tension after loading
toolhead_post_load_tension_adjust: 1	# 1 to enable (recommended), 0 to disable

# If sync-feedback compression sensor is available this test will ensure the filament passes the extruder entry by checking
# for neutral tension when moving filament with just the extruder. Recommended with sprung loaded sync-feedback buffers.
# This is ignored if toolhead sensor is available.
toolhead_entry_tension_test: 1		# 1 to enable (recommended), 0 to disable

# ADVANCED: Controls the detection of successful extruder load/unload movement and represents the fraction of allowable
# mismatch between actual movement and that seen by encoder. Setting to 100% tolerance effectively turns off checking.
# Some designs of extruder have a short move distance that may not be picked up by encoder and cause false errors. This
# allows masking of those errors. However the error often indicates that your extruder load speed is too high or the
# friction is too high on the filament and in that case masking the error is not a good idea. Try reducing friction
# and lowering speed first!
#
toolhead_move_error_tolerance: 60


# Synchronized gear/extruder movement --------------------------------------------------------------------------------
# ███╗   ███╗ ██████╗ ████████╗ ██████╗ ██████╗     ███████╗██╗   ██╗███╗   ██╗ ██████╗
# ████╗ ████║██╔═══██╗╚══██╔══╝██╔═══██╗██╔══██╗    ██╔════╝╚██╗ ██╔╝████╗  ██║██╔════╝
# ██╔████╔██║██║   ██║   ██║   ██║   ██║██████╔╝    ███████╗ ╚████╔╝ ██╔██╗ ██║██║
# ██║╚██╔╝██║██║   ██║   ██║   ██║   ██║██╔══██╗    ╚════██║  ╚██╔╝  ██║╚██╗██║██║
# ██║ ╚═╝ ██║╚██████╔╝   ██║   ╚██████╔╝██║  ██║    ███████║   ██║   ██║ ╚████║╚██████╗
# ╚═╝     ╚═╝ ╚═════╝    ╚═╝    ╚═════╝ ╚═╝  ╚═╝    ╚══════╝   ╚═╝   ╚═╝  ╚═══╝ ╚═════╝
#
# MOTOR SYNCHRONIZATION: This controls whether the extruder and gear steppers are synchronized during printing operations
# If you normally run with maxed out gear stepper current consider reducing it with 'sync_gear_current'
# If equipped with TMC drivers the current of the gear and extruder motors can be controlled to optimize performance.
# This can be useful to control gear stepper temperature when printing with synchronized motor
#
sync_to_extruder: [[PARAM_SYNC_TO_EXTRUDER]]			# Gear motor is synchronized to extruder during print
sync_gear_current: [[PARAM_SYNC_GEAR_CURRENT]]			# % of gear_stepper current (10%-100%) to use when syncing with extruder during print
sync_form_tip: [[PARAM_SYNC_FORM_TIP]]			# Synchronize during standalone tip formation (initial part of unload)
sync_purge: [[PARAM_SYNC_PURGE]]				# Synchronize during standalone purging (last part of load)


[% if MMU_HAS_SYNC_FEEDBACK_BUFFER %]
# Optionally it is possible to leverage feedback from a "compression/expansion" sensor (aka "buffer") in the bowden
# path from MMU to extruder to ensure that the two motors are kept in sync as viewed by the filament (the signal feedback
# state can be binary supplied by one or two switches: -1 (expanded) and 1 (compressed) of proportional value between
# -1.0 and 1.0.
#
# If only "one half" of the sync-feedback is available (either compression-only or tension-only) then the rotation
# distance is always shifted based on the high/low multipliers, however if both tension and compression are available
# then the rotation distance will autotune to correct setting (recommend you also enable 'autotune_rotation_distance: 1'
# so that values are saved)
#
# Possible buffer setups, forth option for type where neutral is when both sensors are active:
#
#   <------maxrange------>       <------maxrange------>       <------maxrange------>       <------maxrange------>
#        <--range--->                  <----range----->       <----range----->                       <> range=0
#   |====================|       |====================|       |====================|       |====================|
#        ^          ^                  ^                                     ^                       ^^
#   compression   tension        compression-only                      tension-only
#
sync_feedback_enabled: [[PARAM_SYNC_FEEDBACK_ENABLED]]			# Turn off even if sensor is installed and active
sync_feedback_buffer_range: [[PARAM_SYNC_FEEDBACK_BUFFER_RANGE]]		# Travel in "buffer" between compression/tension or one sensor and end (see above)
sync_feedback_buffer_maxrange: [[PARAM_SYNC_FEEDBACK_BUFFER_MAXRANGE]]	# Absolute maximum end-to-end travel (mm) provided by buffer (see above)
sync_feedback_speed_multiplier: 5	# % "twolevel" gear speed delta to keep filament neutral in buffer (recommend 5%)
sync_feedback_boost_multiplier: 3	# % "twolevel" extra gear speed boost for finding initial neutral position (recommend 3%)
sync_feedback_extrude_threshold: 5	# Extruder movement (mm) for updates (keep small but set > retract distance)

# If defined this forces debugging to a telemetry log file "sync_<gate>.jsonl". This is great if trying to tune clog/tangle
# detection or for getting help on the Happy Hare forum. To plot graph of sync-feedback operation, run:
#  ~/Happy-Hare/utils/plot_sync_feedback.sh
#
sync_feedback_debug_log: 0		# 0 = disable (normal operation), 1 = enable telemetry log (for debugging)


[% endif %]
[% if MMU_HAS_SYNC_FEEDBACK_BUFFER or MMU_HAS_ENCODER %]
# FlowGuard Clog and Tangle Detection --------------------------------------------------------------------------------
# ███████╗██╗      ██████╗ ██╗    ██╗ ██████╗ ██╗   ██╗ █████╗ ██████╗ ██████╗
# ██╔════╝██║     ██╔═══██╗██║    ██║██╔════╝ ██║   ██║██╔══██╗██╔══██╗██╔══██╗
# █████╗  ██║     ██║   ██║██║ █╗ ██║██║  ███╗██║   ██║███████║██████╔╝██║  ██║
# ██╔══╝  ██║     ██║   ██║██║███╗██║██║   ██║██║   ██║██╔══██║██╔══██╗██║  ██║
# ██║     ███████╗╚██████╔╝╚███╔███╔╝╚██████╔╝╚██████╔╝██║  ██║██║  ██║██████╔╝
# ╚═╝     ╚══════╝ ╚═════╝  ╚══╝╚══╝  ╚═════╝  ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚═════╝
#
# Options are available to automatically detects extruder clogs and MMU tangles. Each option works independently and
# can be combined. Flowguard can even discern the difference between an extruder clog and a spool tangle!
#
# Flowguard:  This intelligently measures filament tension (only available if sync-feedback buffer is fitted)
#
# Encoder detection: This monitors encoder movement and compares to extruder (only available if encoder is fitted)
#
flowguard_enabled: [[PARAM_FLOWGUARD_ENABLED]]			# 0 = Flowguard protection disabled, 1 = Enabled

# The flowguard_max_relief is the amount of relief movement (effective mm change in filament length between MMU and extruder)
# that Happy Hare will wait until triggering a clog or runout. A smaller value is more sensitive to triggering. Since the
# relief movement is hightly dependent on filament "spring" in the bowden tube, filament friction, and
# 'sync_feedback_buffer_range', it is generally good to start high and then decrease if a more sensitive trigger is desired.
# Analog proportional (type P) sensors can generally have a much lower value. Increase if you have false triggers.
flowguard_max_relief: 40

# Encoder runout/clog/tangle detection watches for movement over either a static or automatically adjusted distance - if
# no encoder movement is seen when the extruder moves this distance runout/ clog/tangle event will be generated. Allowing
# the distance to be adjusted automatically (mode=2) will generally allow for a quicker trigger but use a static length
# (mode=1, set encoder_max_motion) if you get false triggers (see flowguard guide on wiki for more details).
# Note that this feature cannot disinguish between clog or tangle.
flowguard_encoder_mode: [[PARAM_FLOWGUARD_ENCODER_MODE]]		# 0 = Disable, 1 = Static detection length, 2 = Autotuned detection length
 
# The encoder_max_motion is the absolute max permitted extruder movement without the encoder seeing movement when using
# status mode (mode=1). Smaller values are more sensitive but beware of going too small - slack and friction in the
# bowden may cause gaps in encoder movement. Increase if you have false triggers.
# Note that this value is overriden by any calibrated value stored in 'mmu_vars.cfg' if in automatic mode (mode=2).
flowguard_encoder_max_motion: 20


[% endif %]
[% if MMU_HAS_ESPOOLER %]
# ESpooler control ---------------------------------------------------------------------------------------------------
# ███████╗███████╗██████╗  ██████╗  ██████╗ ██╗     ███████╗██████╗
# ██╔════╝██╔════╝██╔══██╗██╔═══██╗██╔═══██╗██║     ██╔════╝██╔══██╗
# █████╗  ███████╗██████╔╝██║   ██║██║   ██║██║     █████╗  ██████╔╝
# ██╔══╝  ╚════██║██╔═══╝ ██║   ██║██║   ██║██║     ██╔══╝  ██╔══██╗
# ███████╗███████║██║     ╚██████╔╝╚██████╔╝███████╗███████╗██║  ██║
# ╚══════╝╚══════╝╚═╝      ╚═════╝  ╚═════╝ ╚══════╝╚══════╝╚═╝  ╚═╝
#
# ESPOOLER: If your MMU has a dc motor (often N20) controlled respooler/assist then how it operates can be controlled with these
# settings. Typically the espooler will be controlled with PWM signal. This will be at the maximum at speeds equal or
# above 'espooler.max_stepper_speed'. The PWM signal will scale downwards towards 0 for slower speeds. The falloff being
# controlled by the 'espooler_speed_exponent' setting according to this formula and allows for non-linear characteristics
# the DC motor (0.5 is a good starting value).
#
#     espooler_pwm = (stepper_speed / espooler_max_stepper_speed) ^ espooler_speed_exponent
#
# Regardless of h/w configuration you can enable/disable actions with the 'espooler_operations' list. E.g. remove 'play' to
# turn off operation while printing. Options are:
#
#    rewind - when filament is being unloaded under MMU control (aka respool)
#    assist - when filament is being loaded under MMU control (% of "rewind" speed but with minimum of "print" power)
#    print  - while printing. Generally set 'espooler_printing_power' to a low percentage just to allow motor to be turned
#             freely or set to 0 to enable/allow "burst" assist movements
#
# If using a digitally controlled espooler motor (not PWM) then you should turn off the "print" mode and set
# 'espooler_min_stepper_speed' to prevent "over movement"
#
espooler_min_distance: 30			# Individual stepper movements less than this distance will not active espooler
espooler_max_stepper_speed: 300			# Gear stepper speed at which espooler will be at maximum power
espooler_min_stepper_speed: 0			# Gear stepper speed at which espooler will become inactive (useful for non PWM control)
espooler_speed_exponent: 0.5			# Controls non-linear espooler power relative to stepper speed (see notes)
espooler_assist_reduced_speed: 50		# Control the % of the rewind speed that is applied to assisting load (want rewind to be faster)
espooler_printing_power: 0			# If >0, fixes the % of PWM power while printing. 0=allows burst movement
espooler_operations: rewind, assist, print	# List of operational modes (allows disabling even if h/w is configured)
#
# The following burst configuration is used to control the small rotation in the ASSIST direction optionally used
# when in 'print' operation is enabled, 'espooler_printing_power: 0' and is triggered (tension switch or extruder movement).
# It can also be used to loosen filament with 'MMU_ESPOOLER COMMAND=assist BURST=1'
#
espooler_assist_extruder_move_length: 100	# Distance (mm) extruder needs to move between each assist burst
espooler_assist_burst_power: 100		# The % power of the burst move
espooler_assist_burst_duration: 0.4		# The duration of the burst move is seconds
espooler_assist_burst_trigger: 0		# If trigger assist switch is fitted 0=disable, 1=enable
espooler_assist_burst_trigger_max: 3		# If trigger assist switch is fitted this limits the max number of back-to-back advances
#
# The following burst configuration is used to control the small rotation in the REWIND direction optionally used
# when running running the filament drying cycle. The goal is to rotate the spool 60-90 degrees. It can also be
# used to tighten the filament with 'MMU_ESPOOLER COMMAND=rewind BURST=1'
#
espooler_rewind_burst_power: 100		# The % power of the rewind burst move
espooler_rewind_burst_duration: 0.4		# The duration of the rewind burst move is seconds


[% endif %]
[% if MMU_HAS_HEATER %]
# Heater / Environment Management ------------------------------------------------------------------------------------
# ██╗  ██╗███████╗ █████╗ ████████╗███████╗██████╗
# ██║  ██║██╔════╝██╔══██╗╚══██╔══╝██╔════╝██╔══██╗
# ███████║█████╗  ███████║   ██║   █████╗  ██████╔╝
# ██╔══██║██╔══╝  ██╔══██║   ██║   ██╔══╝  ██╔══██╗
# ██║  ██║███████╗██║  ██║   ██║   ███████╗██║  ██║
# ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝   ╚═╝   ╚══════╝╚═╝  ╚═╝
#
heater_max_temp: [[PARAM_HEATER_MAX_TEMP]]			# Absolute max heater setting to protect the MMU enclosure construction (adjust to match material)
heater_default_dry_temp: 45		# Default drying temperature if filament type is not matched in drying_data
heater_default_dry_time: 300		# Default drying cycle time in minutes
heater_default_dry_humidity: 25		# Default humidity % goal. Drying will terminate if this value is reached
heater_vent_macro: _MMU_VENT		# Name of macro to periodicaly call during drying cycle
heater_vent_interval: 0			# Interval in minutes to call heater_vent_macro during drying cycle, 0=disable venting
heater_rotate_interval: 5		# Interval in minutes to rotate filament (requires eSpooler and filament end attached to spool)


[% endif %]
# Calibration and autotune -------------------------------------------------------------------------------------------
#  ██████╗ █████╗ ██╗     ██╗██████╗ ██████╗  █████╗ ████████╗██╗ ██████╗ ███╗   ██╗
# ██╔════╝██╔══██╗██║     ██║██╔══██╗██╔══██╗██╔══██╗╚══██╔══╝██║██╔═══██╗████╗  ██║
# ██║     ███████║██║     ██║██████╔╝██████╔╝███████║   ██║   ██║██║   ██║██╔██╗ ██║
# ██║     ██╔══██║██║     ██║██╔══██╗██╔══██╗██╔══██║   ██║   ██║██║   ██║██║╚██╗██║
# ╚██████╗██║  ██║███████╗██║██████╔╝██║  ██║██║  ██║   ██║   ██║╚██████╔╝██║ ╚████║
#  ╚═════╝╚═╝  ╚═╝╚══════╝╚═╝╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   ╚═╝ ╚═════╝ ╚═╝  ╚═══╝
#
# CALIBRATION AND AUTOTUNE: These are auto calibration/tuning settings that can be used to ease initial setup and/or to
# tune calibration over time based on measured telemetry. Whether these auto-tuning features are available depends on
# MMU design and configured sensors (explained below). The setting will be ignored if the required sensors are not available
# but if they can operate they will suppress the normal calibration warnings (MMU_STATUS can still be used to view them).
# Note that these are initially set by the installer to recommended values
#
#  autocal_bowden_length      - the calibrated bowden length will be established on first load. It can also be set
#                               manually or reset with MMU_CALIBRATE_BOWDEN. Best results require the use of
#                               sync-feedback-compression or extruder sensor but gear-touch or encoder will also work.
#                               'extruder_homing_endstop' cannot be 'none'
#  autotune_bowden_length     - Once calibrated this setting will tune the bowden distance over time. Works best with
#                               toolhead sensor
#  skip_cal_rotation_distance - This will rely on installed default value (although it can still be calibrated). Usually
#                               a good choice if autotune is enabled
#  autotune_rotation_distance - Requires sync-feedback sensor (aka "buffer") or calibrated encoder. If set then either the
#                               "autotuner" (sync-feedback buffer) or encoder telemetry will be used to adjust the
#                               persisted gear rotation distance.
#  skip_cal_encoder           - Will rely on installed default value (although it can still be calibrated).
#                               Not recommended but allows for easier initial setup especially when 'autotune_encoder'
#                               is enabled.
#  autotune_encoder           - NOT IMPLEMENTED YET. Soon!
#
autocal_bowden_length: [[PARAM_AUTOCAL_BOWDEN_LENGTH]]	# Automated bowden length calibration. 1=automatic, 0=manual/off
autotune_bowden_length: [[PARAM_AUTOTUNE_BOWDEN_LENGTH]]	# Automated bowden length tuning. 1=on, 0=off
skip_cal_rotation_distance: [[PARAM_SKIP_CAL_ROTATION_DISTANCE]]	# Skip rotation distance calibration (MMU_CALIBRATE_GEAR), 1=skip, 0=require
autotune_rotation_distance: [[PARAM_AUTOTUNE_ROTATION_DISTANCE]]	# Automated gate calibration/tuning. 1=automatic, 0=manual/off
skip_cal_encoder: [[PARAM_SKIP_CAL_ENCODER]]		# Skip encoder calibration (MMU_CALIBRATE_ENCODER), 1=skip, 0=require
autotune_encoder: [[PARAM_AUTOTUNE_ENCODER]]		# Automated encoder tuning. 1=automatic, 0=manual/off


# Miscellaneous, but you should review -------------------------------------------------------------------------------
# ███╗   ███╗██╗███████╗ ██████╗
# ████╗ ████║██║██╔════╝██╔════╝
# ██╔████╔██║██║███████╗██║
# ██║╚██╔╝██║██║╚════██║██║
# ██║ ╚═╝ ██║██║███████║╚██████╗
# ╚═╝     ╚═╝╚═╝╚══════╝ ╚═════╝
#
# MISCELLANEOUS: These are supplemental workflow options that apply just to this unit

startup_home_if_unloaded: 0	# 1 = force mmu homing on startup if unloaded, 0 = do nothing
has_filament_buffer: 1          # Whether the MMU has a filament "recoil" buffer. Set to 0 if using Filamentalist or have eSpooler
[% if MMU_HAS_ENCODER %]
encoder_move_validation: 1	# ADVANCED: 1 = Normally Encoder validates move distances are within given tolerance
				#           0 = Validation is disabled (eliminates slight pause between moves but less safe)
[% endif %]


[% if PARAM_SELECTOR_TYPE in ["LinearSelector", "LinearServoSelector", "LinearMultiGearSelector", "IndexedSelector", "Testing"] %]
# CAD dimensions for custom or non-standard designs ------------------------------------------------------------------
#  ██████╗██╗   ██╗███████╗████████╗ ██████╗ ███╗   ███╗    ███╗   ███╗███╗   ███╗██╗   ██╗
# ██╔════╝██║   ██║██╔════╝╚══██╔══╝██╔═══██╗████╗ ████║    ████╗ ████║████╗ ████║██║   ██║
# ██║     ██║   ██║███████╗   ██║   ██║   ██║██╔████╔██║    ██╔████╔██║██╔████╔██║██║   ██║
# ██║     ██║   ██║╚════██║   ██║   ██║   ██║██║╚██╔╝██║    ██║╚██╔╝██║██║╚██╔╝██║██║   ██║
# ╚██████╗╚██████╔╝███████║   ██║   ╚██████╔╝██║ ╚═╝ ██║    ██║ ╚═╝ ██║██║ ╚═╝ ██║╚██████╔╝
#  ╚═════╝ ╚═════╝ ╚══════╝   ╚═╝    ╚═════╝ ╚═╝     ╚═╝    ╚═╝     ╚═╝╚═╝     ╚═╝ ╚═════╝
#
# CUSTOM MMU: Normally all these settings are set based on your choice of 'mmu_vendor' and 'mmu_version' in mmu_hardware.cfg,
# but they can be overridden. If you have selected a vendor of "Other" and your MMU has a selector you must set these CAD based
# dimensions else you will get arbitrary defaults. You may also need to set additional attributes in '[mmu_machine]'
# section of mmu_hardware.cfg.
#
[% if PARAM_SELECTOR_TYPE in ["LinearSelector", "LinearServoSelector", "LinearMultiGearSelector", "Testing"] %]
# LinearSelector, LinearServoSelector, LinearMultiGearSelector: this supports ERCF, Tradrack, custom type-C variations
#cad_gate0_pos: 4.2				# Approximate distance from endstop to first gate. Used for rough calibration only
#cad_gate_width: 21.0				# Width of each gate
#cad_bypass_offset: 0				# Distance from limit of travel back to the bypass (e.g. ERCF v2.0)
#cad_last_gate_offset: 2.0			# Distance from limit of travel back to last gate
#cad_selector_tolerance: 10.0 			# How much extra selector movement to allow for calibration
[% endif %]
[% if PARAM_SELECTOR_TYPE in ["IndexedSelector", "Testing"] %]
# IndexedSelector: this supports BTT ViViD variations
#cad_gate_width: 90.0				# Rotation distance is typicall set to make this equivalent to degrees between gates
#cad_max_rotations: 2				# Maximum full rotations of indexed selector wheel
[% endif %]
[% endif %]
